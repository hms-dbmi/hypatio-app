<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Access Request</title>

</head>
<body>
{% load static %}
<form name="dua_access_form" action="/submit_request/" method="post">
    {# TODO: IF NO DUA, WHAT INSTEAD? #}
    <div id="agreement_form">
    {% if dua %}
        {% if dua_form %}
            {{ dua_form | safe }}
        {% else %}
            {{ dua_text | safe }}

            {% if signatured_required%}
                <br />
                <br />
                Typing your name in the box below signifies you agree with the terms of the Data Use Agreement
                <br />
                <br />
                <input type="text" id="dua_signature" class="form-control" />
            {% endif %}
        {% endif %}
    {% endif %}
    </div>

    <br />
    <br />

    <input type="hidden" id="agreement_text" name="agreement_text" value="" />
    <input type="hidden" id="project_key" name="project_key" value="{{ project_key }}" />
    <input type="hidden" id="data_use_agreement" name="data_use_agreement" value="{{ data_use_agreement }}" />
    <img name="loading" id="loading" src="{% static 'gears.svg' %}" style="display:none;">
    <input name="submit_form" id="submit_form" type="submit" class="btn btn-default" value="Submit for approval" />
    <div id="status" style="color: green; font-size: 1.5em;"></div>

    {% csrf_token %}
</form>

<script type="application/javascript">
    $('form[name=dua_access_form]').submit(function(){

        $("#loading").show();

        // Replace each input field within the dua form with its value, so we have one complete dua form as a string
        $(this).find("#agreement_form").find("input").each(function() {
            $(this).replaceWith($(this).val());
        });

        // Move the content of the agreement_form block into the input in order to be captured by jQuery serialize
        $("#agreement_text").val($("#agreement_form").text());

        $.post($(this).attr('action'), $(this).serialize(), function(res){
            $("#loading").hide();
            $("#status").text("Access request submitted!");
        });

        return false;
    });
</script>

</body>
</html>