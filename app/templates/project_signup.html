{% load projects_extras %}

{% if project.is_contest %}
    <div class="alert alert-info" role="alert">
        To compete in {{ project.short_description }}, please complete the registration process below one step at a time. <strong>All members of your team must complete all registration steps before your account can be activated.</strong>
    </div>
{% else %}
    <div class="alert alert-danger" role="alert">
        To request access to this dataset please complete registration steps below</a>.
    </div>
{% endif %}

<div class="panel-group" id="accordion">

    <!-- Verify email -->
    <div class="panel panel-default">
        <div class="panel-heading project-registration-step" role="tab" id="heading-email">
            <h2 class="panel-title">
                <div class="{% if email_verified %}completed-step-header{% elif current_step == 'verify_email' %}current-step-header{% else %}blocked-step-header{% endif %}">
                    <span>Verify Your Email</span>
                </div>
            </h2>
        </div>
        {% if current_step == 'verify_email' %}
        <div class="panel-body">
            Your primary email on record needs to be verified. Please look in your inbox for the verification email or click below to send another one:
            {% include 'profile/verify_email.html' %}
        </div>
        {% endif %}
    </div>

    <!-- Complete profile -->
    <div class="panel panel-default">
        <div class="panel-heading project-registration-step" role="tab" id="heading-profile">
            <h2 class="panel-title">
                <div class="{% if profile_completed %}completed-step-header{% elif current_step == 'complete_profile' %}current-step-header{% else %}blocked-step-header{% endif %}">
                    <span>Complete Your Profile</span>
                </div>
            </h2>
        </div>
        {% if current_step == 'complete_profile' %}                
        <div class="panel-body">
            <p>There are a few required fields in your profile that need to be filled out. Please complete the profile registration form below, specifically the fields marked as required. You can go back and edit these fields any time by visiting your <a href="{% url 'profile' %}">profile</a> page.</p>
                
            {% include 'profile/registration_form.html' %}
        </div>
        {% endif %}
    </div>

    <!-- Sign forms -->
    {% for agreement_form in agreement_forms_list %}
    <div class="panel panel-default">
        <div class="panel-heading project-registration-step" role="tab" id="heading-form-{{forloop.counter}}">
            <h2 class="panel-title">
                <div class="{% if agreement_form.already_signed %}completed-step-header{% elif current_step == agreement_form.agreement_form_name %}current-step-header{% else %}blocked-step-header{% endif %}">
                    <span>Form: {{ agreement_form.agreement_form_name}}</span>
                </div>
            </h2>
        </div>
        {% if current_step == agreement_form.agreement_form_name %}                
        <div class="panel-body">
            {% if not agreement_form.already_signed %}
            <form name="agreement_form_container" action="/save_signed_agreement_form/" method="post">
                <div class="agreement_form_contents">
                    {{ agreement_form.agreement_form_file|get_agreement_form_file_contents | safe }}
                </div>

                <input type="hidden" class="project_key" name="project_key" value="{{ project.project_key }}" />
                <input type="hidden" class="agreement_form_id" name="agreement_form_id" value="{{ agreement_form.agreement_form_id }}" />
                <input type="hidden" class="agreement_text" name="agreement_text" value="" />

                <hr>

                <div class="submit_form">
                    <input name="submit_form" type="submit" class="btn btn-primary" value="Submit" />
                </div>

                {% csrf_token %}
            </form>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
    
    <!-- Join team -->
    {# Only display this step if this is a contest #}
    {% if project.is_contest %}
    <div class="panel panel-default">
        <div class="panel-heading project-registration-step" role="tab" id="heading-team">
            <h2 class="panel-title">
                {# TODO: If team leader with pending approvals, then current-step #}
                {# TODO: If team leader with all members approved and team status of activated, then green check #}
                {# TODO: If team member pending approval, then current-step #}
                {# TODO: If team member with approval, then green check #}
                <div class="{% if current_step == 'team' %}current-step-header{% else %}blocked-step-header{% endif %}">
                    <span>Your Team</span>
                </div>
            </h2>
        </div>
        {% if current_step == 'team' %}                
        <div class="panel-body">
            {% include "datacontests/teamdetails.html" with participant=participant teams=teams project=project pi_team=pi_team pi_team_members=pi_team_members %}
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>