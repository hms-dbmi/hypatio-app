{% extends 'sub-base.html' %}

{% load static %}
{% load countries %}
{% load projects_extras %}
{% load tz %}

{% block headscripts %}
<!-- For DataTables -->
<script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'plugins/datatables/dataTables.dataTables.min.js' %}"></script>
<script src="{% static 'plugins/datatables/dataTables.bootstrap.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'plugins/datatables/dataTables.dataTables.min.css' %}">
<link rel="stylesheet" href="{% static 'plugins/datatables/dataTables.bootstrap.min.css' %}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
<script src="/static/bootstrap_datepicker_plus/js/datepicker-widget.js"></script>
{% endblock %}

{% block title %}
{{ project.project_key }} Management
{% endblock %}

{% block subcontent %}

<div class="page-header">
  <div class='btn-toolbar pull-right'>
      <div class='btn-group'>
          <button id="manage-collapse-panels-button" type='button' class='btn btn-primary'>Collapse All</button>
          <button id="manage-show-panels-button" type='button' class='btn btn-primary'>Expand All</button>
      </div>
  </div>
  <h3>Essentials</h3>
</div>

<div class="row">
    <div class="col-md-3">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="heading-description">
                <h2 class="panel-title">Registration</h2>
            </div>
            <div class="panel-body">
                <div class="form-group" id="registration-status">
                    {# Pulled this way so intercooler can grab it again when refreshing the section #}
                    {% include 'manage/registration-status.html' with project=project %}
                </div>
                <hr>
                <div class="form-group" id="visible-status">
                    {# Pulled this way so intercooler can grab it again when refreshing the section #}
                    {% include 'manage/visible-status.html' with project=project %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="heading-description">
                <h2 class="panel-title">Details</h2>
            </div>
            <div class="panel-body" id="project-details">
                {# Pulled this way so intercooler can grab it again when refreshing the section #}
                {% include 'manage/project-details.html' with project=project %}
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="heading-description">
                <h2 class="panel-title">Reports and Statistics</h2>
            </div>
            <div class="panel-body">
                <ul class="list-group">
                    <li class="list-group-item">
                        <span class="badge">{{ approved_teams|length }}</span>
                        Approved Teams
                    </li>
                    <li class="list-group-item">
                        <span class="badge">{{ approved_participants|length }}</span>
                        Approved Participants
                    </li>
                    <li class="list-group-item">
                        <span class="badge">{{ total_submissions|length }}</span>
                        Total Submissions
                    </li>
                    <li class="list-group-item">
                        <span class="badge">{{ teams_with_any_submission|length }}</span>
                        Teams With Submissions
                    </li>
                </ul>

                <hr>

                <p><strong>Countries Represented</strong></p>

                <ul class="list-group">
                {% for participating_country in participating_countries %}
                    <li class="list-group-item">
                        <span class="badge">{{ participating_country.n }}</span>
                        {% get_country participating_country.country as country %}
                        {{ country.name }}
                    </li>
                {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12 manage-column">
        <hr>
        <h3>Agreement forms and downloadable files</h3>
    </div>
</div>

<div class="row">
    <div class="col-lg-4">
        <div class="panel panel-default">
            <div class="panel-heading panel-heading-toggle heading-description" role="tab" data-toggle="collapse" data-target="#forms-collapse">
                <h2 class="panel-title">Agreement Forms</h2>
            </div>
            <div id="forms-collapse" class="panel-collapse collapse in">
            <div class="panel-body">
                {% for agreement_form in project.agreement_forms.all %}
                <div class="row">
                    <div class="col-sm-12">
                        <h5>{{ agreement_form.name }}</h5>

                        {% if agreement_form.type == "EXTERNAL_LINK" %}
                            <a href="{{ agreement_form.external_link }}" target="_blank">Go to external webpage</a>
                        {% elif agreement_form.type == "STATIC" %}
                            <a class="preview-agreement-form"
                                data-toggle="modal"
                                data-target="#modal-preview-agreement-form"
                                hx-target="#preview-agreement-form-body"
                                hx-get="{% url 'manage:get-static-agreement-form-html' %}"
                                hx-include='{"project-key": "{{ project.project_key }}", "form-id": "{{ agreement_form.id }}"}'>
                                See preview
                            </a>
                        {% endif %}
                    </div>
                </div>
                <hr>
                {% endfor %}
                <p class="help-block">Please contact a DBMI Tech-Core developer for help with adding or editing an agreement form.</p>
            </div>
          </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="panel panel-default">
            <div class="panel-heading panel-heading-toggle heading-description" role="tab" data-toggle="collapse" data-target="#files-collapse">
                <h2 class="panel-title">Files</h2>
            </div>
            <div id="files-collapse" class="panel-collapse collapse in">
              <div class="panel-body">
                  {% for file_group in file_groups %}
                      <div class="row">
                          <div class="col-sm-12">
                              <h4>{{ file_group.group_name }}:</h4>
                              {% if file_group.files|length == 0 %}
                                  <p>No files in this set</p>
                              {% endif %}
                          </div>
                      </div>
                      {% for hosted_file in file_group.files %}
                          <div class="row hosted-files-container">
                              <div class="col-sm-8">
                                  <h5>
                                      {{ hosted_file.long_name }}
                                  </h5>
                                  {% is_hostedfile_currently_enabled hosted_file as file_enabled %}
                                  {% if file_enabled %}
                                  Downloads currently enabled
                                  {% else %}
                                  <span class="text-danger"><i>Downloads currently disabled</i></span>
                                  {% endif %}
                              </div>

                              <div class="col-sm-4">
                                  <div class="pull-right">
                                      <a class="btn btn-default pull-right edit-agreement-form-button"
                                          href="#"
                                          role="button"
                                          data-toggle="modal"
                                          data-target="#modal-edit-hosted-file"
                                          hx-get="{% url 'manage:get-hosted-file-edit-form' %}"
                                          hx-include='{"hosted-file-uuid": "{{ hosted_file.uuid }}", "project-key": "{{ project.project_key }}"}'
                                          hx-target="#modal-edit-hosted-file-body">
                                          Edit
                                      </a>
                                      <a class="btn btn-default pull-right manage-hosted-file-logs-button"
                                          href="#"
                                          role="button"
                                          data-toggle="modal"
                                          data-target="#modal-hosted-file-logs"
                                          hx-get="{% url 'manage:get-hosted-file-logs' %}"
                                          hx-include='{"hosted-file-uuid": "{{ hosted_file.uuid }}", "project-key": "{{ project.project_key }}"}'
                                          hx-target="#modal-hosted-file-logs-body">
                                          Logs
                                      </a>
                                  </div>
                              </div>
                          </div>
                      {% endfor %}
                      <hr>
                  {% endfor %}
                  <p class="help-block">Please contact a DBMI Tech-Core developer for help with adding a new data file or to move files to different subgroups.</p>
                  <!-- <button class="btn btn-primary pull-right">Add another</button> -->
                   <script nonce="{{request.csp_nonce}}">
                    document.querySelectorAll(".manage-hosted-file-logs-button").forEach((button) => {
                      button.addEventListener("htmx:beforeRequest", function(event) {
                        // Ensure content is removed and loading is shown
                        $("#modal-hosted-file-logs-body").html('<div id="modal-hosted-file-logs-loading" style="text-align: center; margin: 20px;"><i class="fas fa-circle-notch fa-spin fa-2x"></i>&nbsp;&nbsp;Loading...</div>');
                      });
                    });
                   </script>
              </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12 manage-column">
        <hr>
        <h3>Access management</h3>
    </div>
</div>

{% if project.teams_source %}
<div class="row">
    <div class="col-md-12">
        <p><span class="label label-info">Info</span>&nbsp;&nbsp;<strong>This project is configured to import teams from <a href="{% url 'manage:manage-project' project_key=project.teams_source.project_key %}" target="_blank">{{ project.teams_source.name }}</a>.
        {% if project.teams_source_message %}
            {{ project.teams_source_message | safe }}
        {% endif %}
        </strong></p>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-lg-12">
        {% if project.has_teams %}
        <div class="panel-heading panel-heading-toggle heading-description" role="tab" data-toggle="collapse" data-target="#teams-collapse">
            <div class="panel-heading" role="tab" id="heading-description">
                <h2 class="panel-title">Team list</h2>
            </div>
            <div id="teams-collapse" class="panel-collapse collapse in">
              <div class="panel-body">
                  <table id="team-table" class="table table-bordered table-hover table-responsive">
                      <thead>
                          <tr>
                              <th>Team</th>
                              <th>Members</th>
                              <th>Status</th>
                              <th>Downloads</th>
                              <th>Submissions</th>
                          </tr>
                      </thead>
                      <tbody>
                      {% for team in teams %}
                          <tr class="team-row" data-team="{{ team.team_leader }}">
                              <td>{{ team.team_leader }}</td>
                              <td>{{ team.member_count }}</td>
                              <td class="team-status-column">
                              {% if team.status == "Pending" %}
                                  Pending
                              {% elif team.status == "Ready" %}
                                  <span class="label label-warning">Ready to activate</span>
                              {% elif team.status == "Active" %}
                                  Active
                              {% elif team.status == "Deactivated" %}
                                  Deactivated
                              {% endif %}
                              </td>
                              <td>{{ team.downloads }}</td>
                              <td>{{ team.submissions }}</td>
                          </tr>
                      {% endfor %}
                      </tbody>
                  </table>
              </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if not project.automatic_authorization %}
<div class="row">
  <div class="col-lg-12">
      <div class="panel panel-default">
        <div class="panel-heading panel-heading-toggle heading-description" role="tab" data-toggle="collapse" data-target="#pending-participants-collapse">
              <h2 class="panel-title">
                  Pending participant list
              </h2>
          </div>
          <div id="pending-participants-collapse" class="panel-collapse collapse in">
            <div class="panel-body">
                <div class="table-responsive">
                    <table id="pending-participant-table" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Email</th>
                                {% if project.has_teams %}
                                    <th>Team</th>
                                {% endif %}
                                <th>Access</th>
                                <th>Forms</th>
                                <th>Actions</th>
                                <th>Request Date</th>
                            </tr>
                        </thead>
                        <tbody>
                          {# Loaded via DataTables.js #}
                        </tbody>
                    </table>
                </div>
            </div>
          </div>
      </div>
  </div>
</div>
{% endif %}

{% if project.data_use_report_agreement_form %}
<div class="row">
  <div class="col-lg-12">
      <div class="panel panel-default">
        <div class="panel-heading panel-heading-toggle heading-description" role="tab" data-toggle="collapse" data-target="#data-use-reporting-participants-collapse">
              <h2 class="panel-title">
                  Data use reporting participant list
              </h2>
          </div>
          <div id="data-use-reporting-participants-collapse" class="panel-collapse collapse in">
            <div class="panel-body">
                <div class="table-responsive">
                    <table id="data-use-reporting-participant-table" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Email</th>
                                {% if project.has_teams %}
                                    <th>Team</th>
                                {% endif %}
                                <th>Access</th>
                                <th>Forms</th>
                                <th>Actions</th>
                                <th>Request Date</th>
                            </tr>
                        </thead>
                        <tbody>
                          {# Loaded via DataTables.js #}
                        </tbody>
                    </table>
                </div>
            </div>
          </div>
      </div>
  </div>
</div>
{% endif %}

<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-default">
          <div class="panel-heading panel-heading-toggle heading-description" role="tab" data-toggle="collapse" data-target="#participants-collapse">
                <h2 class="panel-title">
                    Full participant list
                </h2>
            </div>
            <div id="participants-collapse" class="panel-collapse collapse in">
              <div class="panel-body">
                  <div class="table-responsive">
                      <table id="participant-table" class="table table-bordered table-hover">
                          <thead>
                              <tr>
                                  <th>Email</th>
                                  {% if project.has_teams %}
                                      <th>Team</th>
                                  {% endif %}
                                  <th>Access</th>
                                  <th>Forms</th>
                                  <th>Actions</th>
                                  <th>Downloads</th>
                                  <th>Uploads</th>
                                  <th>Date</th>
                              </tr>
                          </thead>
                          <tbody>
                            {# Loaded via DataTables.js #}
                          </tbody>
                      </table>
                  </div>
              </div>
            </div>
        </div>
    </div>
</div>

{# Display a table containing all users with workflows #}
{% if workflows %}

<div class="row">
    <div class="col-md-12 manage-column">
        <hr>
        <h3>Workflow management</h3>
    </div>
</div>

<div class="row">
  <div class="col-lg-12">
    <div class="panel panel-default">
      <div class="panel-heading panel-heading-toggle heading-description" role="tab" data-toggle="collapse" data-target="#workflows-collapse">
            <h2 class="panel-title">
              Workflows
                <button id="workflows-refresh-button" type="button" class="btn btn-primary btn-xs pull-right">
                  <i class="glyphicon glyphicon-refresh"></i>
                </button>
            </h2>
      </div>
      <div id="workflows-collapse" class="panel-collapse collapse in">
        <div class="panel-body">
          <ul id="workflows-tab-list" class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active">
              <a href="#workflows-initializations-tab" aria-controls="workflows-initializations-tab" role="tab" data-toggle="tab">
                Initialization Required&nbsp;&nbsp;&nbsp;<span id="workflows-initializations-tab-badge" class="badge"></span>
              </a>
            </li>
            <li role="presentation">
              <a href="#workflows-approvals-tab" aria-controls="workflows-approvals-tab" role="tab" data-toggle="tab">
                Approval Required&nbsp;&nbsp;&nbsp;<span id="workflows-approvals-tab-badge" class="badge"></span>
              </a>
            </li>
            <li role="presentation">
              <a href="#workflows-workflows-tab" aria-controls="workflows-workflows-tab" role="tab" data-toggle="tab">
                Workflows&nbsp;&nbsp;&nbsp;<span id="workflows-workflows-tab-badge" class="badge"></span>
              </a>
            </li>
          </ul>
          <div class="tab-content">
            <div id="workflows-initializations-tab" role="tabpanel" class="tab-pane fade in active">
              <table id="workflows-initializations-table" class="table table-bordered table-hover table-responsive">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Workflow</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
            <div id="workflows-approvals-tab" role="tabpanel" class="tab-pane fade">
              <table id="workflows-approvals-table" class="table table-bordered table-hover table-responsive">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Workflow</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
            <div id="workflows-workflows-tab" role="tabpanel" class="tab-pane fade" id="two">
              <table id="workflows-workflows-table" class="table table-bordered table-hover table-responsive">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Workflow</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script nonce="{{request.csp_nonce}}">
$(function() {
    $('#workflows-approvals-table,#workflows-initializations-table,#workflows-workflows-table').on('click', 'tbody tr', function() {

       let workflowState = {
        id: $(this).data('workflow-id')
       }
       window.location = getWorkflowUrl(workflowState);
    });

    function getWorkflowUrl(workflowState) {
        return "{% url 'manage:workflow-state' workflow_state_id='00000000-0000-0000-0000-000000000000' %}".replace("00000000-0000-0000-0000-000000000000", workflowState.id);
    }

    // Initialize DataTable for workflows
    var workflowsApprovalsTable = $('#workflows-approvals-table').DataTable({
        "ajax": {
            "url": "{% url 'manage:dataproject-workflow-state-list' data_project_key=project.project_key %}?review_required=true",
            "dataSrc": ""
        },
        "columns": [
            { "data": "user.email" },
            { "data": "workflow.name" },
            { "data": "status" }
        ],
        "order": [[0, 'asc']],
        "language": {
            "emptyTable": "No users with workflows found."
        },
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-workflow-id', data.id);
            $(row).addClass('workflows-table-row');
        },
        "initComplete": function(settings, json) {

          // Update the tab's badge
          $('#workflows-approvals-tab-badge').text(json.length ? json.length : '');
        },
        "autoWidth": false
    });

    // Initialize DataTable for workflows
    var workflowsInitializationsTable = $('#workflows-initializations-table').DataTable({
        "ajax": {
            "url": "{% url 'manage:dataproject-workflow-state-list' data_project_key=project.project_key %}?initialization_required=true",
            "dataSrc": ""
        },
        "columns": [
            { "data": "user.email" },
            { "data": "workflow.name" },
            { "data": null, "render": function(data, type, row) {
                // Generate URL
                var workflowUrl = getWorkflowUrl(data);
                return `<a type="button" class="btn btn-primary btn-xs" href="${workflowUrl}">Initialize</a>`;
            } },
        ],
        "order": [[0, 'asc']],
        "language": {
            "emptyTable": "No users with workflows found."
        },
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-workflow-id', data.id);
            $(row).addClass('workflows-table-row');
        },
        "initComplete": function(settings, json) {

          // Update the tab's badge
          $('#workflows-initializations-tab-badge').text(json.length ? json.length : '');
        },
        "autoWidth": false
    });

    // Initialize DataTable for workflows
    var workflowsWorkflowsTable = $('#workflows-workflows-table').DataTable({
        "ajax": {
            "url": "{% url 'manage:dataproject-workflow-state-list' data_project_key=project.project_key %}",
            "dataSrc": ""
        },
        "columns": [
            { "data": "user.email" },
            { "data": "workflow.name" },
            { "data": "status" }
        ],
        "order": [[0, 'asc']],
        "language": {
            "emptyTable": "No users with workflows found."
        },
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-workflow-id', data.id);
            $(row).addClass('workflows-table-row');
        },
        "initComplete": function(settings, json) {

          // Update the tab's badge
          $('#workflows-workflows-tab-badge').text(json.length ? json.length : '');
        },
        "autoWidth": false
    });

    // Update the badge count for a table
    function updateWorkflowTableBadgeCount(badge, json) {

      // Update the tab's badge
      if ( json.length ) {
        $(badge).text(json.length);
      } else {
        $(badge).text("");
      }
    }

    // Track completions
    var completions = {
      workflowsApprovalsTable: false,
      workflowsInitializationsTable: false,
      workflowsWorkflowsTable: false
    };

    $('#workflows-refresh-button').on('click', function(e) {
      e.preventDefault();

      // Animate it
      $(this).find("i").first().addClass("fa-spin");

      // Reset completions.
      Object.keys(completions).forEach(key => {
        completions[key] = false;
      });

      // Refresh the tables.
      workflowsApprovalsTable.ajax.reload(function(json) {

          // Update the tab's badge
          $('#workflows-approvals-tab-badge').text(json.length ? json.length : '');

          // Set completed
          completions.workflowsApprovalsTable = true;
          updateWorkflowsRefreshButton();
      });
      workflowsInitializationsTable.ajax.reload(function(json) {

          // Update the tab's badge
          $('#workflows-initializations-tab-badge').text(json.length ? json.length : '');

          // Set completed
          completions.workflowsInitializationsTable = true;
          updateWorkflowsRefreshButton();
      });
      workflowsWorkflowsTable.ajax.reload(function(json) {

          // Update the tab's badge
          $('#workflows-workflows-tab-badge').text(json.length ? json.length : '');

          // Set completed
          completions.workflowsWorkflowsTable = true;
          updateWorkflowsRefreshButton();
      });

      return false;
    });

    function updateWorkflowsRefreshButton() {

      // If all are done, stop animating.
      if (Object.values(completions).every(value => value === true)) {
        $('#workflows-refresh-button').find("i").first().removeClass("fa-spin");
      }
    }

    // Ensure tables fit their width when being shown when initially hidden.
    $('#workflows-tab-list a[data-toggle="tab"]').on('shown.bs.tab', function (event) {
      DataTable.tables({ visible: true, api: true }).columns.adjust();
    } );

    // Detect when this page is shown when using the browser's back button.
    window.addEventListener("pageshow", function (event) {
      var historyTraversal = event.persisted,
        perf = window.performance,
        perfEntries =
          perf && perf.getEntriesByType && perf.getEntriesByType("navigation"),
        perfEntryType = perfEntries && perfEntries[0] && perfEntries[0].type,
        navigationType = perf && perf.navigation && perf.navigation.type;
      if (
        historyTraversal ||
        perfEntryType === "back_forward" ||
        navigationType === 2
      ) {
        // Handle page restore.
        //workflowsApprovalsTable.ajax.reload();
        //workflowsInitializationsTable.ajax.reload();
        //workflowsWorkflowsTable.ajax.reload();
      }
    });
});
</script>
{% endif %}

{% if project.challengetask_set.count %}

<div class="row">
    <div class="col-md-12 manage-column">
        <hr>
        <h3>Submissions management</h3>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-default">
          <div class="panel-heading panel-heading-toggle heading-description" role="tab" data-toggle="collapse" data-target="#submissions-collapse">
                <h2 class="panel-title">Submissions</h2>
            </div>
            <div id="submissions-collapse" class="panel-collapse collapse in">
              <div class="panel-body">
                  <table id="submissions-table" class="table table-bordered table-hover table-responsive">
                      <thead>
                          <tr>
                              <th>Person</th>
                              {% if project.has_teams %}
                              <th>Team</th>
                              {% endif %}
                              <th>Task</th>
                              <th>Submitted Date</th>
                              <th>File ID</th>
                              <th>Actions</th>
                          </tr>
                      </thead>
                      <tbody>
                          {% for submission in submissions %}
                          <tr>
                              <td>{{ submission.participant.user.email }}</td>
                              {% if project.has_teams %}
                              <td>{{ submission.participant.team.team_leader.email }}</td>
                              {% endif %}
                              <td>{{ submission.challenge_task.title }}</td>
                              <td>{{ submission.upload_date|date:"c" }}</td>
                              <td>{{ submission.uuid }}</td>
                              <td>
                                  <button class="btn btn-default btn-xs view-submission-info" data-toggle="modal" data-target="#modal-submission-info" data-submission-uuid="{{ submission.uuid }}" data-submission-info="{{ submission.submission_info }}">
                                      Details
                                  </button>
                                  <a class="btn btn-default btn-xs btn-default" href="{% url 'manage:download-submission' submission.uuid %}" download>
                                      Download
                                  </a>
                                  {% if project.hosted_submissions %}
                                  <a class="btn btn-default btn-xs btn-success manage-table-cell-button"
                                      href="#"
                                      role="button"
                                      data-toggle="modal"
                                      data-target="#modal-host-submission"
                                      hx-get="{% url 'manage:host-submission' submission.uuid %}"
                                      hx-target="#modal-host-submission-body">
                                      Host
                                  </a>
                                  {% endif %}
                              </td>
                          </tr>
                          {% endfor %}
                      </tbody>
                  </table>
              </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-default">
          <div class="panel-heading panel-heading-toggle heading-description" role="tab" data-toggle="collapse" data-target="#submission-exports-collapse">
                <h2 class="panel-title">Submissions Exports
                  <small>
                      <button id="manage-export-submissions-button"
                        type="button"
                        class="btn btn-primary btn-xs pull-right manage-panel-header-right-button"
                        hx-indicator="#manage-export-submissions-indicator"
                        hx-get="{% url 'manage:export-submissions' project.project_key %}">
                          Export Submissions <i id="manage-export-submissions-indicator" class="hx-indicator fa fa-spinner fa-spin"></i>
                      </button>
                      <script nonce="{{request.csp_nonce}}">
                        document.getElementById("manage-export-submissions-button").addEventListener("htmx:afterRequest", function(event) {
                          // Ensure success
                          if(event.detail.successful) {

                            // Open the modal
                            $('#export-modal').modal();
                          }
                        });
                      </script>
                  </small>
                </h2>
            </div>
            <div id="submission-exports-collapse" class="panel-collapse collapse in">
              <div class="panel-body">
                  <table id="submissions-exports-table" class="table table-bordered table-hover table-responsive">
                      <thead>
                          <tr>
                              <th>Requester</th>
                              <th>Requested Date</th>
                              <th>File ID</th>
                              <th>Actions</th>
                          </tr>
                      </thead>
                      <tbody>
                          {% for export in submissions_exports %}
                          <tr>
                              <td>{{ export.requester.email }}</td>
                              <td>{{ export.request_date|date:"c" }}</td>
                              <td>{{ export.uuid }}</td>
                              <td>
                                  <button onclick="window.location.href='{% url 'manage:download-submissions-export' project.project_key export.uuid %}'" class="btn btn-default btn-xs btn-default">
                                      Download
                                  </button>
                              </td>
                          </tr>
                          {% endfor %}
                      </tbody>
                  </table>
              </div>
            </div>
        </div>
    </div>
</div>

{% endif %}

<div id="modal-submission-info" class="modal fade">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="submission-info-modal">Submission Info</h4>
            </div>
            <div class="modal-body">
                <pre id="submission-info-display">
                    ...
                </pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-host-submission" class="modal fade">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="submission-info-modal">Host Submission</h4>
            </div>
            <div class="modal-body" id="modal-host-submission-body">
                {# Loaded via Intercooler.js #}
            </div>
        </div>
    </div>
</div>

<div id="modal-preview-agreement-form" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h5 class="modal-title">Preview agreement form</h5>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" role="alert">
                    This is a preview of how your form is displayed to users registering for your data project. If you see anything that needs to be changed, please reach out to a DBMI Tech-Core developer for assistance.
                </div>

                <div id="preview-agreement-form-body">
                    ...
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-edit-hosted-file" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h5 class="modal-title">Edit File</h5>
            </div>

            <div class="modal-body" id="modal-edit-hosted-file-body">
                {# Loaded via Intercooler.js #}
            </div>
        </div>
    </div>
</div>

<div id="modal-hosted-file-logs" class="modal fade">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h5 class="modal-title">File Download Logs</h5>
            </div>

            <div class="modal-body" id="modal-hosted-file-logs-body">
                {# Loaded via Intercooler.js #}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="sync-modal" tabindex="-1" role="dialog" aria-labelledby="sync-modal-title">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
        <h5 class="modal-title" id="sync-modal-title">Permissions Sync</h5>
      </div>
      <div class="modal-body">
          <p>Permissions for the current project were successfully synced</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary manage-reload-page-button" data-dismiss="modal">Reload Page</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="export-modal" tabindex="-1" role="dialog" aria-labelledby="export-modal-title">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
          </button>
          <h5 class="modal-title" id="export-modal-title">Submissions Export</h5>
        </div>
        <div class="modal-body">
            <p>The submissions export task has been started. You will receive an email when it is ready for download. You can also try refreshing the page in a few minutes to see it in the table when competed.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary manage-reload-page-button" data-dismiss="modal">Reload Page</button>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block footerscripts %}
<script nonce="{{request.csp_nonce}}">

    $('#modal-hosted-file-logs').on('shown.bs.modal', function () {
      $.fn.dataTable.tables( {visible: true, api: true} ).columns.adjust();
    });

    $(document).ready(function() {
        $('#team-table').DataTable({
            // Order by the Status column to prioritize pending access.
            "order": [[2, "desc"]]
        });

        var pendingParticipantTable = $('#pending-participant-table').DataTable({
            // Order by the Access column to prioritize pending access.
            "dom": 'Blfrtip',
            "processing": true,
            "serverSide": true,
            "bAutoWidth": false,
            "ajax": "{% url 'manage:get-project-pending-participants' project_key=project_key %}",
            "initComplete": function(settings, json) {
              var textBox = $('#pending-participant-table_filter label input');
              textBox.unbind();
              textBox.bind('keyup input', function(e) {
                  if(e.keyCode == 8 && !textBox.val() || e.keyCode == 46 && !textBox.val()) {
                      // do nothing ¯\_(ツ)_/¯
                  } else if(e.keyCode == 13 || !textBox.val()) {
                    pendingParticipantTable.search(this.value).draw();
                  }
              });
            },
            "order": [[{% if project.has_teams %}5{% else %}4{% endif %}, "desc"]],
            "columnDefs": [
                {
                    "targets": [{% if project.has_teams %}1, 2, 3{% else %}1, 2{% endif %}],
                    "orderable": false
                },
                {
                    "targets": {% if project.has_teams %}3{% else %}2{% endif %},
                    "render":  function(data, type, full, meta) {

                        // Build HTML render
                        var html = '';

                        // Data is an array of forms
                        for (index = 0; index < data.length; index++) {

                            // Get the form
                            var form = data[index];

                            // Set the base URL for the forms
                            var formUrl = '{% url "projects:signed_agreement_form" %}?project_key=' + form['project'] + '&signed_form_id=' + form['id'];

                            // Set form type and icon classes
                            var formClasses = (function(formStatus) {
                              switch(formStatus) {
                                case 'P':
                                  return ['btn-warning', 'glyphicon-alert'];
                                case 'A':
                                  return ['btn-default', 'glyphicon-ok'];
                                case 'R':
                                  return ['btn-danger', 'glyphicon-ban-circle'];
                                default:
                                  return ['btn-warning', 'glyphicon-alert'];
                              }
                            })(form['status']);

                            // Set link HTML with placeholders for button classes
                            var link = '<a style="display: block; margin: 2px;" ' +
                                'class="btn btn-default btn-xs ' + formClasses[0] +
                                ' download-signed-form" href="' + formUrl +
                                '" target="_blank" role="button">' + form['name'] +
                                '  <span class="glyphicon ' + formClasses[1] +
                                '" aria-hidden="true"></span></a>';

                            // Append it to the other elements
                            html += link
                        }

                        return html;
                    }
                },
                {
                    "targets": {% if project.has_teams %}4{% else %}3{% endif %},
                    "render":  function(data, type, full, meta) {

                        // Determine output based on access, forms signed, etc.
                        if(data['access']) {

                            // Set the URL for revoking access
                            var buttonUrl = '{% url "manage:remove-view-permission" project_key=project_key user_email='USER_EMAIL' %}'.replace('USER_EMAIL',  data['email']);

                            // Return the button to revoke
                            return '<button type="button" class="btn btn-default btn-xs manage-participant-change-access-button" ' +
                                'hx-post="' + buttonUrl + '">' +
                                'Revoke access  ' +
                                '<span class="glyphicon glyphicon-ban-circle" ' +
                                'aria-hidden="true"></span></button>';

                        } else if(data['signed'] == data['required'] && !data['team']) {

                            // Set the URL for approving access
                            var buttonUrl = '{% url "manage:grant-view-permission" project_key=project_key user_email='USER_EMAIL' %}'.replace('USER_EMAIL',  data['email']);

                            // Return button to approve user
                            return '<button type="button" class="btn btn-default btn-xs btn-success manage-participant-change-access-button" ' +
                                'hx-post="' + buttonUrl + '">' +
                                'Grant access  ' +
                                '<span class="glyphicon glyphicon-alert" aria-hidden="true"></span>' +
                                '</button>';

                        } else if(data['signed'] == data['required'] && data['team']) {

                            return 'Grant approval via team management.';

                        } else {

                            return 'Forms incomplete or pending your review';
                        }
                    }
                },
                {
                    "targets": [{% if project.has_teams %}5{% else %}4{% endif %}],
                    "render": function (data, type, full, meta) {

                        // Return raw dates for sorting
                        if (type === 'sort' || type === 'type')
                            return data;

                        // Parse date and get components
                        var date = new Date(data);
                        var y = date.getFullYear();
                        var m = date.getMonth() + 1;
                        var d = date.getDate();
                        var h = date.getHours();
                        var min = ("0" + date.getMinutes()).slice(-2);

                        return m + '-' + d + '-' + y + ' ' + h + ':' + min;
                    }
                }
            ],
            "drawCallback": function( settings ) {

              // Collect all Intercooler links
              htmx.process(document.querySelector('#pending-participant-table tbody'));

              document.querySelectorAll(".manage-participant-change-access-button").forEach((button) => {

                  // Add event listener
                  button.addEventListener("htmx:afterRequest", function(event) {

                    // Check success
                    if(event.detail.successful) {
                      reloadParticipantTables();
                    }
                  });
              });
            },
        });

        var participantTable = $('#participant-table').DataTable({
            // Order by the Access column to prioritize pending access.
            "dom": 'Blfrtip',
            "searching": true,
            "bAutoWidth": false,
            "search": {
              "return": true
            },
            "initComplete": function(settings, json) {
              var textBox = $('#participant-table_filter label input');
              textBox.unbind();
              textBox.bind('keyup input', function(e) {
                  if(e.keyCode == 8 && !textBox.val() || e.keyCode == 46 && !textBox.val()) {
                      // do nothing ¯\_(ツ)_/¯
                  } else if(e.keyCode == 13 || !textBox.val()) {
                    participantTable.search(this.value).draw();
                  }
              });
            },
            "processing": true,
            "serverSide": true,
            "ajax": "{% url 'manage:get-project-participants' project_key=project_key %}",
            "language": {
                 "lengthMenu": "_MENU_ per page",
                 "zeroRecords": "No records found",
                 "info": "Showing <b>_START_ to _END_</b> (of _TOTAL_)",
                 "infoFiltered": "",
                 "infoEmpty": "No records found",
                 "processing": '<i class="fa fa-spinner fa-spin fa-2x fa-fw"></i>'
            },
            "columnDefs": [
                {
                    "targets": [{% if project.has_teams %}1, 2, 3, 5, 6{% else %}1, 2, 4, 5{% endif %}],
                    "orderable": false
                },
                {
                    "targets": {% if project.has_teams %}3{% else %}2{% endif %},
                    "render":  function(data, type, full, meta) {

                        // Build HTML render
                        var html = '';

                        // Data is an array of forms
                        for (index = 0; index < data.length; index++) {

                            // Get the form
                            var form = data[index];

                            // Set the base URL for the forms
                            var formUrl = '{% url "projects:signed_agreement_form" %}?project_key=' + form['project'] + '&signed_form_id=' + form['id'];

                            // Set form type and icon classes
                            var formClasses = (function(formStatus) {
                              switch(formStatus) {
                                case 'P':
                                  return ['btn-warning', 'glyphicon-alert'];
                                case 'A':
                                  return ['btn-default', 'glyphicon-ok'];
                                case 'R':
                                  return ['btn-danger', 'glyphicon-ban-circle'];
                                default:
                                  return ['btn-warning', 'glyphicon-alert'];
                              }
                            })(form['status']);

                            // Set link HTML with placeholders for button classes
                            var link = '<a style="display: block; margin: 2px;" ' +
                                'class="btn btn-default btn-xs ' + formClasses[0] +
                                ' download-signed-form" href="' + formUrl +
                                '" target="_blank" role="button">' + form['name'] +
                                '  <span class="glyphicon ' + formClasses[1] +
                                '" aria-hidden="true"></span></a>';

                            // Append it to the other elements
                            html += link
                        }

                        return html;
                    }
                },
                {
                    "targets": {% if project.has_teams %}4{% else %}3{% endif %},
                    "render":  function(data, type, full, meta) {

                        // Determine output based on access, forms signed, etc.
                        if(data['access']) {

                            // Set the URL for revoking access
                            var buttonUrl = '{% url "manage:remove-view-permission" project_key=project_key user_email='USER_EMAIL' %}'.replace('USER_EMAIL',  data['email']);

                            // Return the button to revoke
                            return '<button type="button" class="btn btn-default btn-xs manage-participant-change-access-button" ' +
                                'hx-post="' + buttonUrl + '">' +
                                'Revoke access  ' +
                                '<span class="glyphicon glyphicon-ban-circle" ' +
                                'aria-hidden="true"></span></button>';

                        } else if(data['signed'] >= data['required'] && !data['team']) {

                            // Set the URL for approving access
                            var buttonUrl = '{% url "manage:grant-view-permission" project_key=project_key user_email='USER_EMAIL' %}'.replace('USER_EMAIL',  data['email']);

                            // Return button to approve user
                            return '<button type="button" class="btn btn-default btn-xs btn-success manage-participant-change-access-button" ' +
                                'hx-post="' + buttonUrl + '">' +
                                'Grant access  ' +
                                '<span class="glyphicon glyphicon-alert" aria-hidden="true"></span>' +
                                '</button>';

                        } else if(data['signed'] >= data['required'] && data['team']) {

                            return 'Grant approval via team management.';

                        } else {

                            return 'Forms incomplete or pending your review';
                        }
                    }
                }
            ],
            "drawCallback": function( settings ) {

              // Collect all Intercooler links
              htmx.process(document.querySelector('#participant-table tbody'));

              document.querySelectorAll(".manage-participant-change-access-button").forEach((button) => {

                  // Add event listener
                  button.addEventListener("htmx:afterRequest", function(event) {

                    // Check success
                    if(event.detail.successful) {
                      setTimeout(function() { reloadParticipantTables(); }, 500);
                    }
                  });
              });
            },
        });

        $('#submissions-table').DataTable({
            "columnDefs": [{
                "targets": [{% if project.has_teams %}3{% else %}2{% endif %}],
                "render":  function(data, type, full, meta){

                    // Check for a valid date timestamp
                    var pattern = new RegExp("[0-9]+");
                    if (!pattern.test(data)) {
                        if (type === 'sort' || type === 'type') {
                            return 0;
                        } else {
                            return data;
                        }
                    }

                    // Return raw dates for sorting
                    if (type === 'sort' || type === 'type')
                        return data;

                    // Parse date and get components
                    var date = new Date(data);
                    return date.toLocaleString();
                }
            }]
        });

        $('#submissions-exports-table').DataTable({
            "columnDefs": [{
                "targets": [1],
                "render":  function(data, type, full, meta){

                    // Check for a valid date timestamp
                    var pattern = new RegExp("[0-9]+");
                    if (!pattern.test(data)) {
                        if (type === 'sort' || type === 'type') {
                            return 0;
                        } else {
                            return data;
                        }
                    }

                    // Return raw dates for sorting
                    if (type === 'sort' || type === 'type')
                        return data;

                    // Parse date and get components
                    var date = new Date(data);
                    return date.toLocaleString();
                }
            }]
        });

        var dataUseReportingParticipantTable = $('#data-use-reporting-participant-table').DataTable({
          // Order by the Access column to prioritize pending access.
          "dom": 'Blfrtip',
          "processing": true,
          "serverSide": true,
          "bAutoWidth": false,
          "ajax": "{% url 'manage:get-project-data-use-reporting-participants' project_key=project_key %}",
          "initComplete": function(settings, json) {
            var textBox = $('#data-use-reporting-participant-table_filter label input');
            textBox.unbind();
            textBox.bind('keyup input', function(e) {
                if(e.keyCode == 8 && !textBox.val() || e.keyCode == 46 && !textBox.val()) {
                    // do nothing ¯\_(ツ)_/¯
                } else if(e.keyCode == 13 || !textBox.val()) {
                  pendingParticipantTable.search(this.value).draw();
                }
            });
          },
          "order": [[{% if project.has_teams %}5{% else %}4{% endif %}, "desc"]],
          "columnDefs": [
              {
                  "targets": [{% if project.has_teams %}1, 2, 3{% else %}1, 2{% endif %}],
                  "orderable": false
              },
              {
                  "targets": {% if project.has_teams %}3{% else %}2{% endif %},
                  "render":  function(data, type, full, meta) {

                      // Build HTML render
                      var html = '';

                      // Data is an array of forms
                      for (index = 0; index < data.length; index++) {

                          // Get the form
                          var form = data[index];

                          // Set the base URL for the forms
                          var formUrl = '{% url "projects:signed_agreement_form" %}?project_key=' + form['project'] + '&signed_form_id=' + form['id'];

                          // Set form type and icon classes
                          var formClasses = (function(formStatus) {
                            switch(formStatus) {
                              case 'P':
                                return ['btn-warning', 'glyphicon-alert'];
                              case 'A':
                                return ['btn-default', 'glyphicon-ok'];
                              case 'R':
                                return ['btn-danger', 'glyphicon-ban-circle'];
                              default:
                                return ['btn-warning', 'glyphicon-alert'];
                            }
                          })(form['status']);

                          // Set link HTML with placeholders for button classes
                          var link = '<a style="display: block; margin: 2px;" ' +
                              'class="btn btn-default btn-xs ' + formClasses[0] +
                              ' download-signed-form" href="' + formUrl +
                              '" target="_blank" role="button">' + form['name'] +
                              '  <span class="glyphicon ' + formClasses[1] +
                              '" aria-hidden="true"></span></a>';

                          // Append it to the other elements
                          html += link
                      }

                      return html;
                  }
              },
              {
                  "targets": {% if project.has_teams %}4{% else %}3{% endif %},
                  "render":  function(data, type, full, meta) {

                      // Determine output based on access, forms signed, etc.
                      if(data['access']) {

                          // Set the URL for revoking access
                          var buttonUrl = '{% url "manage:remove-view-permission" project_key=project_key user_email='USER_EMAIL' %}'.replace('USER_EMAIL',  data['email']);

                          // Return the button to revoke
                          return '<button type="button" class="btn btn-default btn-xs manage-participant-change-access-button" ' +
                              'hx-post="' + buttonUrl + '">' +
                              'Revoke access  ' +
                              '<span class="glyphicon glyphicon-ban-circle" ' +
                              'aria-hidden="true"></span></button>';

                      } else if(data['signed'] + 1 == data['required'] && !data['team']) {

                          // Set the URL for approving access
                          var buttonUrl = '{% url "manage:grant-view-permission" project_key=project_key user_email='USER_EMAIL' %}'.replace('USER_EMAIL',  data['email']);

                          // Return button to approve user
                          return '<button type="button" class="btn btn-default btn-xs btn-success manage-participant-change-access-button" ' +
                              'hx-post="' + buttonUrl + '">' +
                              'Grant access  ' +
                              '<span class="glyphicon glyphicon-alert" aria-hidden="true"></span>' +
                              '</button>';

                      } else if(data['signed'] >= data['required'] && data['team']) {

                          return 'Grant approval via team management.';

                      } else {

                          return 'Forms incomplete or awaiting your approval';
                      }
                  }
              },
              {
                  "targets": [{% if project.has_teams %}5{% else %}4{% endif %}],
                  "render": function (data, type, full, meta) {

                      // Return raw dates for sorting
                      if (type === 'sort' || type === 'type')
                          return data;

                      // Parse date and get components
                      var date = new Date(data);
                      var y = date.getFullYear();
                      var m = date.getMonth() + 1;
                      var d = date.getDate();
                      var h = date.getHours();
                      var min = ("0" + date.getMinutes()).slice(-2);

                      return m + '-' + d + '-' + y + ' ' + h + ':' + min;
                  }
              }
          ],
          "drawCallback": function( settings ) {

              // Collect all Intercooler links
              htmx.process(document.querySelector('#data-use-reporting-participant-table tbody'));

              document.querySelectorAll(".manage-participant-change-access-button").forEach((button) => {

                  // Add event listener
                  button.addEventListener("htmx:afterRequest", function(event) {

                    // Check success
                    if(event.detail.successful) {
                      reloadParticipantTables();
                    }
                  });
              });
          },
      });
    });
</script>

<!-- When clicking a team row, open a new window for team managment -->
<script nonce="{{request.csp_nonce}}">
  $(document).ready(function() {
      $('#team-table').on("click", ".team-row", function() {
          var team = $(this).data('team');
          window.open("./" + team + "/");

          // Because the user may now delete the team or change its status, mention
          // that they should refresh the page to see any changes
          var teamStatus = $(this).find('.team-status-column');
          teamStatus.html('<span class="label label-default">Refresh to see changes</span>');
      });

    $('.view-submission-info').on('click', function() {
        var submission_uuid = $(this).data('submission-uuid');

        // Grab the information from an adjacent div
        var submission_info = $(this).data('submission-info');

        // Parse the string into an actual json
        var submission_info_json_prettyprint = JSON.stringify(submission_info, null, 4);

        // Paste the json into the modal and pretty print it
        $('#submission-info-display').html(submission_info_json_prettyprint);
    });
  });

  function reloadParticipantTables() {

    // Force redraw each of the tables
    $('#pending-participant-table').DataTable().draw(false);
    $('#data-use-reporting-participant-table').DataTable().draw(false);
    $('#participant-table').DataTable().draw(false);
  }
</script>
{% endblock %}
