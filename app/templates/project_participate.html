{% extends 'base.html' %}
{% load projects_extras %}
{% load bootstrap3 %}
{% load tz %}

{% block headscripts %}
{% endblock %}

{% block tab_name %}{{ team.data_project.name }}{% endblock %}
{% block title %}{{ team.data_project.name }}{% endblock %}
{% block subtitle %}{{ team.data_project.short_description }}{% endblock %}

{% block extrainfo %}
<button type="button" class="btn btn-success" data-toggle="team-status-tooltip" data-placement="left" title="Your team has been approved for access to this challenge. In the sections below, you will be able to download training and test data sets and upload your solutions.">
    Team status: active
</button>
{% endblock %}

{% block content %}

{% if messages %}
{% include 'messages.html' %}
{% endif %}

<div class="row">
    <div class="col-md-6">

        <div class="panel panel-primary">
            <div class="panel-heading" role="tab" id="heading-description">
                <h2 class="panel-title">Challenge Description</a></h2>
            </div>
            <div class="panel-body pre-scrollable">
                {% autoescape off %}
                {{ team.data_project.description }}
                {% endautoescape %}
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="heading-description">
                <h2 class="panel-title">Your Team</a></h2>
            </div>
            <div class="panel-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Submissions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for participant in team.participant_set.all %}
                        <tr>
                            <td>
                                {{ participant.user.email }}
                                {% if team.team_leader == participant.user %}
                                    &nbsp;&nbsp;<span class="label label-primary">Team leader</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ participant.participantsubmission_set.all|length }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="heading-description">
                <h2 class="panel-title">Your Agreement Forms</a></h2>
            </div>
            <div class="panel-body">
                {% for agreement_form in final_signed_agreement_forms %}
                    <h4>{{ agreement_form.agreement_form.name }}</h4>
                    <div class="row">
                        <div class="col-md-8">
                            Signed {{ agreement_form.date_signed|timezone:"America/New_York" }} (EST)
                        </div>
                        <div class="col-md-4">
                            <a class="btn btn-default btn-sm" href="/projects/signed_agreement_form/?signed_form_id={{ agreement_form.id }}&project_key={{ project.project_key }}" target="_blank" role="button">View</a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

    </div>

    <div class="col-md-6">

        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="heading-description">
                <h2 class="panel-title">Available Downloads</a></h2>
            </div>
            <div class="panel-body">
                <div class="alert alert-danger" role="alert">
                    Reminder: Gaining access to any portion of the 2018 n2c2 data commits your team to participate in the evaluation that will be run by n2c2, to submit a paper describing your developed system, and to present your work in the follow-up workshop to be organized by n2c2 (should your paper be accepted for presentation). <b>Teams cannot withdraw after gaining access to the data.</b> (See <a href="https://n2c2.dbmi.hms.harvard.edu/conduct.php">Rules of Conduct</a> and <a href="https://n2c2.dbmi.hms.harvard.edu/dua.php">Data Use Agreement</a>).
                </div>

                {% for file in project.hostedfile_set.all %}
                    {% if file.enabled or user.is_superuser %}
                        <hr>
                        <h4>{{ file.long_name }}</h4>
                        <div class="row">
                            <div class="col-md-9">
                                {{ file.description }}
                            </div>
                            <div class="col-md-3">
                                <a href="/download_dataset/?file_id={{ file.id }}" class="btn btn-default download-file-button" download>Download</a>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        {% if project.accepting_user_submissions %}
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="heading-description">
                <h2 class="panel-title">Uploads</a></h2>
            </div>
            <div class="panel-body">
            {% if team.get_number_of_submissions_left == 0 %}
                Your team has used up all of its available submissions.
            {% else %}
                <div class="alert alert-warning" role="alert">
                    Something here about what exactly you're submitting and a reminder that each team has a limited number of submissions.
                </div>
                <h5>Your team has {{ team.get_number_of_submissions_left }} submissions left. </h5>
                <form id="file-upload-form">
                    {% csrf_token %}

                    <label class="btn btn-default" id="file-upload-browse">
                        Click to browse for a file... <input id="file-upload-file" name="file" type="file" style="display: none;">
                    </label>
                    <input id="file-upload-filename" name="filename" type="text" hidden="true" />
                    <input id="file-upload-project" name="project" type="text" hidden="true" value="{{ project.project_key }}" />
                    <button id="file-upload-submit" type="submit" class="btn btn-danger" style="display: none;"
                    data-loading-text="<i class='fa fa-circle-o-notch fa-spin'></i> Uploading file..."></button>

                </form>

                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block footerscripts %}
<script type="application/javascript">
    // Enable the team status tooltip
    $(function () {
        $('[data-toggle="team-status-tooltip"]').tooltip()
    });
</script>
<script type="application/javascript">

    function objectifyForm( formArray ) {
        var returnArray = {};
        for (var i = 0; i < formArray.length; i++){
            returnArray[formArray[i]['name']] = formArray[i]['value'];
        }
        return returnArray;
    }

    $( document ).ready(function() {

        // Automatically update the filename field when a file
        // is selected by the user.
        $(document).on('change', '#file-upload-form input[name=file]', function () {
            var input = $(this);
            var fileName = input.val().replace(/\\/g, '/').replace(/.*\//, '');

            $('#file-upload-submit').text('Submit ' + fileName);
            $('#file-upload-browse').hide();
            $('#file-upload-submit').show();

            $('#file-upload-filename').val(fileName);
        });

        // Set the handler for the form
        $(document).on('submit', '#file-upload-form', function (event) {
            console.log('form.submit');

            // Get the file
            var file = $("#file-upload-form input[name=file]").prop('files')[0];
            if(file == null) {

                // Quit with error
                error('A file has not been selected, please try again');
                return false;
            }

            // Get the form data.
            var form = objectifyForm($('#file-upload-form').serializeArray());

            // Remove the file from the data.
            delete form['file'];

            // Add info about the file
            form['content_type'] = file.content;

            // Disable the form and the buttons.
            $("#file-upload-submit").button('loading');

            // Inform the server that the uploade completed
            $.ajax({
                method: "POST",
                data: form,
                url: "/upload_dataset/",
                success: function (data, textStatus, jqXHR) {
                    console.log("submit.success: " + textStatus);

                    // Do the upload
                    upload(data["post"], data["file"], file);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log("submit.error: " + errorThrown);

                    // Error with message
                    error('Something happened, please try again');
                }
            });

            return false;
        });

        function upload(post, fileRecord, file) {
            console.log('upload: ' + fileRecord["filename"]);

            // construct the needed data using the policy for AWS
            var form = new FormData();
            var fields = post["fields"];
            for(var key in fields) {
                form.append(key, fields[key]);
            }

            // Add the file
            form.append('file', file);

            // Post it!
            $.ajax({
                    url: post["url"],
                    datatype: 'xml',
                    data: form,
                    type: 'POST',
                    contentType: false,
                    processData: false,
                    xhr: function () {

                        // Add a progress handler
                        var xhr = $.ajaxSettings.xhr();
                        xhr.upload.onprogress = progress;

                        // Allow aborting the upload.
                        $('#file-upload-close-button').click(function() {

                            xhr.abort();
                        });
                        return xhr;
                    },
                    success: function (data, textStatus, jqXHR) {
                        console.log('upload.success: ' + textStatus);

                        // Do not allow the upload to be cancelled at this point
                        $("#file-upload-form :input").prop("disabled", true);

                        // Inform the server that the uploade completed
                        complete(fileRecord);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log('upload.error: ' + errorThrown + ', ' + textStatus);

                        // Check if aborted
                        if( !jqXHR.getAllResponseHeaders() ) {
                            // Cancelled notification
                            aborted();

                        } else {

                            // Error with message
                            error('Something happened, please try again');
                        }
                    }
                });
        }

        function complete(fileRecord) {
            console.log('complete: ' + fileRecord["filename"]);

            // Inform the server that the uploade completed
            $.ajax({
                method: "PATCH",
                data: fileRecord,
                url: "/upload_dataset/",
                success: function (data, textStatus, jqXHR) {
                    console.log("complete.success: " + textStatus);

                    // Notify.
                    success();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log("complete.error: " + errorThrown);

                    // Error with message
                    error('Something happened, please try again');
                }
            });
        }

        function progress(event) {

            // Ensure it can be used
            if (event.lengthComputable) {

                // Calculate progress.
                var progress = event.loaded / event.total * 100;
                console.log('upload.progress: ' + progress);

                // Update UI if needed
            }
        }

        function error(message) {

            // Cleanup
            cleanup();

            // Notify.
            notify('danger', message, 'glyphicon glyphicon-remove');
        }

        function aborted() {

            // Cleanup
            cleanup();

            // Notify.
            notify('warning', 'The upload was cancelled', 'glyphicon glyphicon-warning-sign');
        }

        function success() {

            // Add a little delay
            setTimeout(function(){

                // Cleanup
                cleanup();

                // Notify.
                notify('success', 'The upload has completed successfully!', 'glyphicon glyphicon-ok');
            }, 1000);
        }

        function cleanup() {

            // Reset the form
            $('#file-upload-form').trigger('reset');
            $('#file-upload-browse').show();
            $('#file-upload-submit').button('reset');
            $('#file-upload-submit').hide();
        }
    });
</script>
{% endblock %}